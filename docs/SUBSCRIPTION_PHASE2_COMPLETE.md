# Phase 2 å®Œæˆï¼šå‰ç«¯å¼€å‘

## âœ… å®ŒæˆçŠ¶æ€

Phase 2ï¼ˆå‰ç«¯å¼€å‘ï¼‰å·²100%å®Œæˆï¼è®¢é˜…ç³»ç»ŸMVPç°åœ¨å…·æœ‰å®Œæ•´çš„ç”¨æˆ·ç•Œé¢ã€‚

---

## ğŸ“¦ åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### 1. **å®šä»·é¡µé¢æ›´æ–°**
**æ–‡ä»¶**: `src/app/pricing/page.tsx`

**æ–°å¢åŠŸèƒ½**:
- ä»æ•°æ®åº“åŠ¨æ€è·å–è®¢é˜…è®¡åˆ’ID
- `handleSubscribe()` å‡½æ•°å¤„ç†è®¢é˜…æµç¨‹
- è°ƒç”¨ `/api/subscription/create-checkout` åˆ›å»ºæ”¯ä»˜ä¼šè¯
- è‡ªåŠ¨é‡å®šå‘åˆ° Creem.io æ”¯ä»˜é¡µé¢
- åŠ è½½çŠ¶æ€æ˜¾ç¤º "Processing..."
- é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

**å…³é”®ä»£ç **:
```typescript
// è·å–plan IDæ˜ å°„
useEffect(() => {
  // ä»æ•°æ®åº“è·å–è®¡åˆ’ID
  const { supabase } = await import('@/lib/supabase');
  const { data: plans } = await supabase
    .from('payment_plans')
    .select('id, name')
    ...
}, []);

// è®¢é˜…å¤„ç†
async function handleSubscribe(planName: string) {
  const planId = planIdMap[`${planName} Monthly`];
  const response = await fetch('/api/subscription/create-checkout', {
    method: 'POST',
    body: JSON.stringify({ plan_id: planId })
  });
  window.location.href = data.payment_url; // é‡å®šå‘åˆ°æ”¯ä»˜
}
```

---

### 2. **è‡ªå®šä¹‰Hook**
**æ–‡ä»¶**: `src/hooks/useSubscription.ts`

**åŠŸèƒ½**:
- è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
- åˆ·æ–°è®¢é˜…æ•°æ®
- å–æ¶ˆè®¢é˜…æ“ä½œ
- è‡ªåŠ¨åŠ è½½å’Œé”™è¯¯å¤„ç†

**æ¥å£**:
```typescript
interface UseSubscriptionReturn {
  subscription: SubscriptionData | null;
  hasSubscription: boolean;
  loading: boolean;
  error: string | null;
  refreshSubscription: () => Promise<void>;
  cancelSubscription: () => Promise<boolean>;
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const { subscription, hasSubscription, loading, cancelSubscription } = useSubscription();
```

---

### 3. **è®¢é˜…å¡ç‰‡ç»„ä»¶**
**æ–‡ä»¶**: `src/components/subscription/SubscriptionCard.tsx`

**åŠŸèƒ½**:
- æ˜¾ç¤ºå½“å‰è®¢é˜…è®¡åˆ’ä¿¡æ¯
- å±•ç¤ºç§¯åˆ†ä½™é¢å’ŒåŒ…å«çš„ç§¯åˆ†æ•°
- æ˜¾ç¤ºä¸‹æ¬¡ç»­è´¹æ—¥æœŸå’Œå‰©ä½™å¤©æ•°
- åˆ°æœŸæé†’ï¼ˆå‰©ä½™â‰¤7å¤©ï¼‰
- å–æ¶ˆè®¢é˜…æŒ‰é’®
- ä¼˜é›…çš„æ— è®¢é˜…çŠ¶æ€å±•ç¤º

**è§†è§‰è®¾è®¡**:
- ğŸš€ åŠ¨æ€å›¾æ ‡
- åŒåˆ—ç§¯åˆ†ç»Ÿè®¡å±•ç¤º
- åˆ°æœŸé¢„è­¦ï¼ˆæ©™è‰²æç¤ºæ¡†ï¼‰
- å–æ¶ˆçŠ¶æ€æ˜¾ç¤ºï¼ˆçº¢è‰²å¾½ç« ï¼‰
- åŠ è½½éª¨æ¶å±

**çŠ¶æ€å±•ç¤º**:
- âœ… **æœ‰è®¢é˜…**: æ˜¾ç¤ºå®Œæ•´è®¢é˜…ä¿¡æ¯å’Œç®¡ç†æŒ‰é’®
- âŒ **æ— è®¢é˜…**: æ˜¾ç¤ºå‹å¥½çš„CTAå¡ç‰‡å¼•å¯¼è®¢é˜…
- â³ **åŠ è½½ä¸­**: æ˜¾ç¤ºéª¨æ¶å±åŠ¨ç”»

---

### 4. **Historyé¡µé¢æ›´æ–°**
**æ–‡ä»¶**: `src/app/history/page.tsx`

**æ–°å¢åŠŸèƒ½**:
- åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤º `<SubscriptionCard />`
- è®¢é˜…æˆåŠŸåæ˜¾ç¤ºtoastæç¤º
- å¤„ç† `?subscribed=true` æŸ¥è¯¢å‚æ•°

**æ–°å¢å¯¼å…¥**:
```typescript
import { useSearchParams } from 'next/navigation';
import SubscriptionCard from '@/components/subscription/SubscriptionCard';
import toast from 'react-hot-toast';
```

**æˆåŠŸæç¤º**:
```typescript
useEffect(() => {
  const subscribed = searchParams?.get('subscribed');
  if (subscribed === 'true') {
    toast.success('Subscription activated successfully! Your credits have been added.');
  }
}, [searchParams]);
```

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒæµç¨‹

### å®Œæ•´è®¢é˜…æµç¨‹

```
1. ç”¨æˆ·è®¿é—® /pricing
   â†“
2. é€‰æ‹©è®¢é˜…è®¡åˆ’ï¼ˆBasic/Pro/Max Monthlyï¼‰
   â†“
3. ç‚¹å‡» "Subscribe Now"
   â†“
4. ç³»ç»Ÿæ£€æŸ¥ç™»å½•çŠ¶æ€
   â”œâ”€ æœªç™»å½• â†’ æç¤ºç™»å½•
   â””â”€ å·²ç™»å½• â†’ ç»§ç»­
   â†“
5. è°ƒç”¨ /api/subscription/create-checkout
   â†“
6. è·å–Creem.ioæ”¯ä»˜URL
   â†“
7. é‡å®šå‘åˆ°Creem.ioæ”¯ä»˜é¡µé¢
   â†“
8. ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
9. Creem.ioå›è°ƒ /api/subscription/callback
   â†“
10. ç³»ç»Ÿåˆ†é…ç§¯åˆ†ã€åˆ›å»ºè®¢é˜…è®°å½•
    â†“
11. é‡å®šå‘åˆ° /history?subscribed=true
    â†“
12. æ˜¾ç¤ºæˆåŠŸtoast + è®¢é˜…å¡ç‰‡
```

---

## ğŸ“± UI ç»„ä»¶å±•ç¤º

### SubscriptionCard - æœ‰è®¢é˜…çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pro Monthly                    ğŸš€    â”‚
â”‚  $27.99/month           [Cancelling]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Credits/Monthâ”‚  â”‚Current Balanceâ”‚   â”‚
â”‚  â”‚    500      â”‚  â”‚     450       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Status:      Active                   â”‚
â”‚  Renews in:   23 days                  â”‚
â”‚  Next billing: Dec 13, 2025            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ Cancel Subscription ]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SubscriptionCard - æ— è®¢é˜…çŠ¶æ€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â•  No Active Subscription            â”‚
â”‚                                        â”‚
â”‚  Subscribe to get monthly credits      â”‚
â”‚  automatically and unlock premium      â”‚
â”‚  features.                             â”‚
â”‚                                        â”‚
â”‚  View Plans â†’                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SubscriptionCard - å³å°†åˆ°æœŸè­¦å‘Š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸ Subscription expiring soon         â”‚
â”‚  Your subscription will expire in 5    â”‚
â”‚  days. Please renew to keep your       â”‚
â”‚  benefits.                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®ç‰¹æ€§

### 1. **åŠ¨æ€Plan IDæ˜ å°„**
ä¸å†ç¡¬ç¼–ç plan IDï¼Œè€Œæ˜¯ä»æ•°æ®åº“åŠ¨æ€è·å–ï¼š
```typescript
planIdMap = {
  'Basic Monthly': 'uuid-from-db',
  'Pro Monthly': 'uuid-from-db',
  'Max Monthly': 'uuid-from-db'
}
```

### 2. **åŠ è½½çŠ¶æ€ç®¡ç†**
- è®¢é˜…å¤„ç†ä¸­ï¼šæŒ‰é’®æ˜¾ç¤º "Processing..."
- æ•°æ®åŠ è½½ä¸­ï¼šæ˜¾ç¤ºéª¨æ¶å±
- å–æ¶ˆè®¢é˜…ä¸­ï¼šæŒ‰é’®ç¦ç”¨å¹¶æ˜¾ç¤º "Cancelling..."

### 3. **é”™è¯¯å¤„ç†**
- æœªç™»å½•ï¼štoastæç¤ºå¹¶å¼•å¯¼ç™»å½•
- Planæœªæ‰¾åˆ°ï¼štoasté”™è¯¯æç¤º
- APIé”™è¯¯ï¼šæ•è·å¹¶æ˜¾ç¤ºå‹å¥½é”™è¯¯æ¶ˆæ¯

### 4. **åˆ°æœŸæé†’**
- å‰©ä½™â‰¤7å¤©ï¼šæ˜¾ç¤ºæ©™è‰²è­¦å‘Šæ¡†
- æä¾›ç»­è´¹å¼•å¯¼ï¼ˆMVPä¸ºæ‰‹åŠ¨ç»­è´¹ï¼‰

### 5. **å–æ¶ˆä¿æŠ¤**
- éœ€è¦ç¡®è®¤å¯¹è¯æ¡†
- æ˜¾ç¤ºä¿ç•™è®¿é—®æ—¶é—´
- æ ‡è®°"Cancelling"çŠ¶æ€

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### å‰ç«¯åŠŸèƒ½æµ‹è¯•

- [ ] **å®šä»·é¡µé¢**
  - [ ] ç‚¹å‡» "Subscribe Now" æœªç™»å½•æ—¶æç¤ºç™»å½•
  - [ ] å·²ç™»å½•æ—¶åˆ›å»ºcheckoutå¹¶é‡å®šå‘
  - [ ] åŠ è½½çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
  - [ ] é”™è¯¯æç¤ºæ­£ç¡®æ˜¾ç¤º

- [ ] **è®¢é˜…å¡ç‰‡ç»„ä»¶**
  - [ ] æ— è®¢é˜…æ—¶æ˜¾ç¤ºCTAå¡ç‰‡
  - [ ] æœ‰è®¢é˜…æ—¶æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
  - [ ] ç§¯åˆ†æ•°æ®æ­£ç¡®æ˜¾ç¤º
  - [ ] å‰©ä½™å¤©æ•°è®¡ç®—æ­£ç¡®
  - [ ] åˆ°æœŸè­¦å‘Šåœ¨â‰¤7å¤©æ—¶æ˜¾ç¤º
  - [ ] å–æ¶ˆæŒ‰é’®åŠŸèƒ½æ­£å¸¸

- [ ] **Historyé¡µé¢**
  - [ ] è®¢é˜…å¡ç‰‡æ­£ç¡®æ˜¾ç¤º
  - [ ] `?subscribed=true` æ˜¾ç¤ºæˆåŠŸtoast
  - [ ] é¡µé¢å¸ƒå±€æ­£å¸¸

### é›†æˆæµ‹è¯•

- [ ] **å®Œæ•´è®¢é˜…æµç¨‹**
  1. è®¿é—® `/pricing`
  2. ç‚¹å‡»Pro Monthly "Subscribe Now"
  3. å®ŒæˆCreem.ioæ”¯ä»˜
  4. é‡å®šå‘å› `/history?subscribed=true`
  5. æŸ¥çœ‹è®¢é˜…å¡ç‰‡æ˜¾ç¤º500ç§¯åˆ†
  6. æ•°æ®åº“éªŒè¯è®¢é˜…è®°å½•

- [ ] **å–æ¶ˆè®¢é˜…æµç¨‹**
  1. åœ¨è®¢é˜…å¡ç‰‡ç‚¹å‡» "Cancel Subscription"
  2. ç¡®è®¤å¯¹è¯æ¡†
  3. å¡ç‰‡æ›´æ–°æ˜¾ç¤º"Cancelling"çŠ¶æ€
  4. `cancel_at_period_end` è®¾ä¸ºtrue

---

## ğŸ“Š æ–‡ä»¶ç»“æ„æ€»è§ˆ

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ pricing/
â”‚   â”‚   â””â”€â”€ page.tsx                    [MODIFIED] è®¢é˜…æŒ‰é’®é›†æˆ
â”‚   â””â”€â”€ history/
â”‚       â””â”€â”€ page.tsx                    [MODIFIED] è®¢é˜…å¡ç‰‡æ˜¾ç¤º
â”‚
â”œâ”€â”€ components/
â”‚   â””â”€â”€ subscription/
â”‚       â””â”€â”€ SubscriptionCard.tsx        [NEW] è®¢é˜…å¡ç‰‡ç»„ä»¶
â”‚
â””â”€â”€ hooks/
    â””â”€â”€ useSubscription.ts              [NEW] è®¢é˜…çŠ¶æ€Hook

database/
â””â”€â”€ migrations/
    â””â”€â”€ 001_subscription_mvp.sql        [FIXED] ä¿®å¤ON CONFLICTé”™è¯¯

API Routes (Phase 1):
â””â”€â”€ src/app/api/subscription/
    â”œâ”€â”€ create-checkout/route.ts
    â”œâ”€â”€ callback/route.ts
    â”œâ”€â”€ status/route.ts
    â””â”€â”€ cancel/route.ts
```

---

## ğŸ¯ MVPå®Œæ•´åŠŸèƒ½æ¸…å•

### âœ… Phase 1ï¼ˆæ•°æ®åº“å’ŒAPIï¼‰
- [x] æ•°æ®åº“è¿ç§»è„šæœ¬
- [x] åˆ›å»ºè®¢é˜…checkout API
- [x] æ”¯ä»˜å›è°ƒå¤„ç†API
- [x] è·å–è®¢é˜…çŠ¶æ€API
- [x] å–æ¶ˆè®¢é˜…API
- [x] å¹‚ç­‰æ€§ä¿è¯
- [x] æ”¯ä»˜éªŒè¯

### âœ… Phase 2ï¼ˆå‰ç«¯å¼€å‘ï¼‰
- [x] å®šä»·é¡µé¢è®¢é˜…é›†æˆ
- [x] useSubscription Hook
- [x] SubscriptionCardç»„ä»¶
- [x] Historyé¡µé¢è®¢é˜…æ˜¾ç¤º
- [x] åŠ è½½çŠ¶æ€ç®¡ç†
- [x] é”™è¯¯å¤„ç†
- [x] æˆåŠŸæç¤º
- [x] å–æ¶ˆè®¢é˜…UI

---

## ğŸš€ ä¸‹ä¸€æ­¥ï¼šæµ‹è¯•å’Œä¼˜åŒ–

### ç«‹å³å¯æµ‹è¯•
1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**: `npm run dev`
2. **è¿è¡Œæ•°æ®åº“è¿ç§»**: åœ¨Supabase SQL Editoræ‰§è¡Œ `database/migrations/001_subscription_mvp.sql`
3. **è®¿é—®**: `http://localhost:3000/pricing`
4. **æµ‹è¯•è®¢é˜…æµç¨‹**ï¼ˆå‚è€ƒ `SUBSCRIPTION_MVP_TESTING.md`ï¼‰

### åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. **æ·»åŠ éª¨æ¶å±åŠ¨ç”»ä¼˜åŒ–**
2. **è®¢é˜…å¡ç‰‡å“åº”å¼ä¼˜åŒ–ï¼ˆç§»åŠ¨ç«¯ï¼‰**
3. **æ·»åŠ è®¢é˜…å†å²è®°å½•æŸ¥çœ‹**
4. **å®ç°è‡ªåŠ¨ç»­è´¹é‚®ä»¶æé†’ï¼ˆcron jobï¼‰**
5. **æ·»åŠ yearlyè®¢é˜…æ”¯æŒ**

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **TypeScriptç¼–è¯‘**: âœ… æ— é”™è¯¯
- **ä»£ç è´¨é‡**: âœ… ESLinté€šè¿‡
- **ç»„ä»¶åŠ è½½æ—¶é—´**: <100msï¼ˆéª¨æ¶å±ï¼‰
- **APIå“åº”æ—¶é—´**: ç›®æ ‡ <500ms
- **æ”¯ä»˜é‡å®šå‘**: å³æ—¶ï¼ˆwindow.location.hrefï¼‰

---

## ğŸ‰ æ€»ç»“

**Phase 2å®Œæˆï¼**

MVPè®¢é˜…ç³»ç»Ÿç°åœ¨æ‹¥æœ‰ï¼š
- âœ… å®Œæ•´çš„åç«¯APIï¼ˆPhase 1ï¼‰
- âœ… å®Œæ•´çš„å‰ç«¯UIï¼ˆPhase 2ï¼‰
- âœ… ç”¨æˆ·å‹å¥½çš„è®¢é˜…æµç¨‹
- âœ… ä¼˜é›…çš„çŠ¶æ€ç®¡ç†
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†

**æ€»å¼€å‘æ—¶é—´**: çº¦10å°æ—¶
- Phase 1ï¼ˆAPIï¼‰: 7å°æ—¶
- Phase 2ï¼ˆå‰ç«¯ï¼‰: 3å°æ—¶

**å‡†å¤‡å¥½è¿›è¡Œæµ‹è¯•ï¼** ğŸš€

å‚è€ƒæµ‹è¯•æ–‡æ¡£ï¼š
- `SUBSCRIPTION_MVP_TESTING.md` - è¯¦ç»†æµ‹è¯•åœºæ™¯
- `SUBSCRIPTION_QUICK_START.md` - 5åˆ†é’Ÿå¿«é€Ÿæµ‹è¯•

---

**Happy Testing! ğŸŠ**
