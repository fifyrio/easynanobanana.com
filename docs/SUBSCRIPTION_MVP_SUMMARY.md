# è®¢é˜…ä»˜è´¹ç³»ç»Ÿ MVP å®æ–½æ€»ç»“

## ğŸ‰ å®ŒæˆçŠ¶æ€ï¼šæ•°æ®åº“å’ŒAPIå±‚å·²å®Œæˆ

### âœ… å·²å®Œæˆçš„å·¥ä½œ

#### 1. æ•°æ®åº“è¿ç§»è„šæœ¬
**æ–‡ä»¶**: `database/migrations/001_subscription_mvp.sql`

**æ–°å¢å­—æ®µ**:
- `subscriptions` è¡¨:
  - `cancel_at_period_end` - æ˜¯å¦åœ¨å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ
  - `cancelled_at` - å–æ¶ˆæ—¶é—´æˆ³
  - `renewal_reminder_sent` - æ˜¯å¦å·²å‘é€ç»­è´¹æé†’

- `user_profiles` è¡¨:
  - `active_plan_id` - å½“å‰æ´»è·ƒè®¢é˜…è®¡åˆ’ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰
  - `subscription_expires_at` - è®¢é˜…åˆ°æœŸæ—¶é—´ï¼ˆåèŒƒå¼åŒ–ï¼‰

- `orders` è¡¨:
  - `subscription_id` - å…³è”è®¢é˜…è®°å½•
  - `is_renewal` - æ˜¯å¦ä¸ºç»­è´¹è®¢å•

**æ–°å¢ç´¢å¼•**:
- `idx_subscriptions_user_status` - æŒ‰ç”¨æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢
- `idx_subscriptions_renewal` - ç»­è´¹æé†’æŸ¥è¯¢
- `idx_user_profiles_subscription` - æŒ‰è®¡åˆ’æŸ¥è¯¢ç”¨æˆ·

**ç§å­æ•°æ®**:
- 3ä¸ªæœˆä»˜è®¢é˜…è®¡åˆ’ï¼ˆBasic/Pro/Maxï¼‰

---

#### 2. API è·¯ç”±ï¼ˆ4ä¸ªï¼‰

##### 2.1 åˆ›å»ºè®¢é˜…ç»“è´¦ä¼šè¯
**è·¯ç”±**: `POST /api/subscription/create-checkout`

**åŠŸèƒ½**:
- éªŒè¯ç”¨æˆ·èº«ä»½
- æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒè®¢é˜…ï¼ˆé˜²æ­¢é‡å¤è®¢é˜…ï¼‰
- åˆ›å»ºå¾…å¤„ç†è®¢å•
- è°ƒç”¨ Creem.io åˆ›å»ºæ”¯ä»˜ä¼šè¯
- è¿”å›æ”¯ä»˜URL

**è¯·æ±‚ä½“**:
```json
{
  "plan_id": "uuid"
}
```

**å“åº”**:
```json
{
  "success": true,
  "payment_url": "https://www.creem.io/test/payment/...",
  "order_id": "uuid",
  "checkout_id": "checkout_..."
}
```

---

##### 2.2 æ”¯ä»˜å›è°ƒå¤„ç†
**è·¯ç”±**: `GET /api/subscription/callback?order_id=xxx&status=success`

**åŠŸèƒ½**:
- å¤„ç† Creem.io æ”¯ä»˜æˆåŠŸ/å–æ¶ˆé‡å®šå‘
- éªŒè¯æ”¯ä»˜çŠ¶æ€ï¼ˆè°ƒç”¨ Creem.io APIï¼‰
- **å¹‚ç­‰æ€§è®¾è®¡**ï¼šæ£€æŸ¥è®¢å•æ˜¯å¦å·²å®Œæˆï¼Œé˜²æ­¢é‡å¤å¤„ç†
- åˆ›å»ºè®¢é˜…è®°å½•
- åˆ†é…ç§¯åˆ†ï¼ˆé€šè¿‡ credit_transactionsï¼‰
- æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
- é‡å®šå‘åˆ°ä»ªè¡¨ç›˜

**å…³é”®ç‰¹æ€§**:
- âœ… æ”¯ä»˜éªŒè¯ï¼ˆä¸åªä¿¡ä»»URLå‚æ•°ï¼‰
- âœ… å¹‚ç­‰æ€§ï¼ˆé‡å¤è®¿é—®ä¸ä¼šé‡å¤å‘æ”¾ç§¯åˆ†ï¼‰
- âœ… åŸå­æ€§æ“ä½œï¼ˆæ‰€æœ‰æ•°æ®åº“å†™å…¥åœ¨try-catchå—å†…ï¼‰
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•ï¼ˆä¾¿äºè°ƒè¯•ï¼‰

---

##### 2.3 è·å–è®¢é˜…çŠ¶æ€
**è·¯ç”±**: `GET /api/subscription/status`

**åŠŸèƒ½**:
- è¿”å›ç”¨æˆ·å½“å‰è®¢é˜…è¯¦æƒ…
- è®¡ç®—å‰©ä½™å¤©æ•°
- è¿”å›ç§¯åˆ†ä½™é¢

**å“åº”ç¤ºä¾‹**:
```json
{
  "hasSubscription": true,
  "subscription": {
    "id": "uuid",
    "planName": "Pro Monthly",
    "creditsIncluded": 500,
    "creditsRemaining": 500,
    "status": "active",
    "currentPeriodStart": "2025-11-13T...",
    "currentPeriodEnd": "2025-12-13T...",
    "daysRemaining": 30,
    "cancelAtPeriodEnd": false,
    "price": 27.99,
    "currency": "USD"
  }
}
```

---

##### 2.4 å–æ¶ˆè®¢é˜…
**è·¯ç”±**: `POST /api/subscription/cancel`

**åŠŸèƒ½**:
- æ ‡è®°è®¢é˜…åœ¨å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ
- ç”¨æˆ·ä¿ç•™ç§¯åˆ†å’Œè®¿é—®æƒé™ç›´åˆ°åˆ°æœŸ
- é˜²æ­¢è‡ªåŠ¨ç»­è´¹ï¼ˆMVPä¸ºæ‰‹åŠ¨ç»­è´¹ï¼‰

**å“åº”**:
```json
{
  "success": true,
  "message": "Subscription will be cancelled at period end. You will keep access until then.",
  "expiresAt": "2025-12-13T..."
}
```

---

#### 3. æµ‹è¯•æ–‡æ¡£
**æ–‡ä»¶**: `SUBSCRIPTION_MVP_TESTING.md`

**åŒ…å«å†…å®¹**:
- 6ä¸ªå®Œæ•´æµ‹è¯•åœºæ™¯
- æ•°æ®åº“éªŒè¯SQL
- APIè¯·æ±‚ç¤ºä¾‹ï¼ˆcurlå‘½ä»¤ï¼‰
- æ•…éšœæ’æŸ¥æŒ‡å—
- æ§åˆ¶å°æ—¥å¿—ç¤ºä¾‹
- å¿«é€Ÿæµ‹è¯•è„šæœ¬

---

### ğŸ“ æ–‡ä»¶ç»“æ„

```
/database/migrations/
  001_subscription_mvp.sql                      âœ… å·²åˆ›å»º

/src/app/api/subscription/
  create-checkout/route.ts                       âœ… å·²åˆ›å»º
  callback/route.ts                              âœ… å·²åˆ›å»º
  status/route.ts                                âœ… å·²åˆ›å»º
  cancel/route.ts                                âœ… å·²åˆ›å»º

/SUBSCRIPTION_MVP_TESTING.md                     âœ… å·²åˆ›å»º
/SUBSCRIPTION_MVP_SUMMARY.md                     âœ… æ­¤æ–‡æ¡£
```

---

### ğŸ” å…³é”®æŠ€æœ¯å®ç°

#### å¹‚ç­‰æ€§ä¿è¯
```typescript
// æ£€æŸ¥è®¢å•æ˜¯å¦å·²å®Œæˆ
if (order.status === 'completed') {
  console.log('Order already completed, skipping processing (idempotent)');
  return NextResponse.redirect(new URL('/dashboard?subscribed=true', request.url));
}
```

#### æ”¯ä»˜éªŒè¯
```typescript
// ä¸åªä¿¡ä»»URLå‚æ•°ï¼Œå¿…é¡»éªŒè¯ Creem.io çŠ¶æ€
const checkoutStatus = await creemClient.getCheckoutStatus(order.external_order_id);
if (checkoutStatus.status !== 'completed' && checkoutStatus.status !== 'paid') {
  return redirect('/pricing?error=payment_pending');
}
```

#### ç§¯åˆ†åˆ†é…
```typescript
// é€šè¿‡ credit_transactions è¡¨è§¦å‘å™¨è‡ªåŠ¨æ›´æ–° user_profiles.credits
await serviceSupabase
  .from('credit_transactions')
  .insert({
    user_id: order.user_id,
    amount: plan.credits,
    transaction_type: 'purchase',
    description: `${plan.name} subscription - ${plan.credits} credits`,
    order_id: order.id
  });
```

---

### ğŸ§ª æµ‹è¯•æ£€æŸ¥æ¸…å•

åœ¨ç»§ç»­å‰ç«¯å¼€å‘å‰ï¼Œè¯·å®Œæˆä»¥ä¸‹æµ‹è¯•ï¼š

- [ ] **è¿è¡Œæ•°æ®åº“è¿ç§»**
  ```bash
  psql YOUR_DATABASE_URL -f database/migrations/001_subscription_mvp.sql
  ```

- [ ] **éªŒè¯ç¯å¢ƒå˜é‡é…ç½®**
  - `PAYMENT_ENV=test`
  - `CREEM_TEST_*_PRODUCT_ID` å·²è®¾ç½®

- [ ] **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
  ```bash
  npm run dev
  ```

- [ ] **æµ‹è¯•åœºæ™¯1**: æˆåŠŸè®¢é˜…Pro Monthly
  - è®¿é—® `/pricing` â†’ ç‚¹å‡»è®¢é˜… â†’ å®Œæˆæ”¯ä»˜
  - éªŒè¯ï¼š500ç§¯åˆ†åˆ°è´¦ï¼Œè®¢é˜…çŠ¶æ€active

- [ ] **æµ‹è¯•åœºæ™¯2**: å–æ¶ˆæ”¯ä»˜
  - å¼€å§‹è®¢é˜…æµç¨‹ï¼Œåœ¨æ”¯ä»˜é¡µé¢å–æ¶ˆ
  - éªŒè¯ï¼šæ— ç§¯åˆ†åˆ†é…ï¼Œè®¢å•çŠ¶æ€failed

- [ ] **æµ‹è¯•åœºæ™¯3**: å¹‚ç­‰æ€§æµ‹è¯•
  - é‡å¤è®¿é—®callback URL
  - éªŒè¯ï¼šä¸é‡å¤å‘æ”¾ç§¯åˆ†

- [ ] **æµ‹è¯•åœºæ™¯4**: è·å–è®¢é˜…çŠ¶æ€API
  ```bash
  curl -X GET http://localhost:3000/api/subscription/status \
    -H "Authorization: Bearer TOKEN"
  ```

- [ ] **æµ‹è¯•åœºæ™¯5**: å–æ¶ˆè®¢é˜…
  ```bash
  curl -X POST http://localhost:3000/api/subscription/cancel \
    -H "Authorization: Bearer TOKEN"
  ```

- [ ] **æµ‹è¯•åœºæ™¯6**: é˜²æ­¢é‡å¤è®¢é˜…
  - å·²æœ‰è®¢é˜…æ—¶å°è¯•å†æ¬¡è®¢é˜…
  - éªŒè¯ï¼šè¿”å›400é”™è¯¯

---

### ğŸš€ ä¸‹ä¸€æ­¥ï¼šå‰ç«¯å¼€å‘

æµ‹è¯•é€šè¿‡åï¼ŒPhase 2å‰ç«¯å¼€å‘åŒ…æ‹¬ï¼š

#### 2.1 æ›´æ–°å®šä»·é¡µé¢
**æ–‡ä»¶**: `src/app/pricing/page.tsx`

**éœ€è¦æ·»åŠ **:
- `handleSubscribe` å‡½æ•°
- è°ƒç”¨ `/api/subscription/create-checkout`
- é‡å®šå‘åˆ° Creem.io æ”¯ä»˜é¡µé¢

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### 2.2 åˆ›å»ºè®¢é˜…å¡ç‰‡ç»„ä»¶
**æ–‡ä»¶**: `src/components/SubscriptionCard.tsx`

**åŠŸèƒ½**:
- æ˜¾ç¤ºå½“å‰è®¢é˜…è®¡åˆ’
- æ˜¾ç¤ºå‰©ä½™å¤©æ•°å’Œç§¯åˆ†
- æä¾›å–æ¶ˆè®¢é˜…æŒ‰é’®
- æ˜¾ç¤ºå–æ¶ˆçŠ¶æ€ï¼ˆå¦‚æœå·²æ ‡è®°å–æ¶ˆï¼‰

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

#### 2.3 åˆ›å»ºè‡ªå®šä¹‰Hook
**æ–‡ä»¶**: `src/hooks/useSubscription.ts`

**åŠŸèƒ½**:
- è·å–è®¢é˜…çŠ¶æ€
- åˆ·æ–°è®¢é˜…æ•°æ®
- å–æ¶ˆè®¢é˜…æ“ä½œ

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

#### 2.4 æ›´æ–°ä»ªè¡¨ç›˜
**æ–‡ä»¶**: `src/app/dashboard/page.tsx`

**æ·»åŠ **:
- æ˜¾ç¤º `<SubscriptionCard />` ç»„ä»¶
- å¤„ç† `?subscribed=true` æŸ¥è¯¢å‚æ•°ï¼ˆæ˜¾ç¤ºæˆåŠŸæç¤ºï¼‰

**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

---

### ğŸ“Š MVPåŠŸèƒ½èŒƒå›´

#### âœ… åŒ…å«çš„åŠŸèƒ½
- âœ… æœˆä»˜è®¢é˜…ï¼ˆBasic/Pro/Maxï¼‰
- âœ… Creem.io æ”¯ä»˜é›†æˆ
- âœ… è‡ªåŠ¨ç§¯åˆ†åˆ†é…
- âœ… è®¢é˜…çŠ¶æ€æŸ¥è¯¢
- âœ… å‘¨æœŸç»“æŸæ—¶å–æ¶ˆ
- âœ… é˜²æ­¢é‡å¤è®¢é˜…
- âœ… å¹‚ç­‰æ€§ä¿è¯
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

#### âŒ ä¸åŒ…å«çš„åŠŸèƒ½ï¼ˆPhase 2+ï¼‰
- âŒ å¹´ä»˜è®¢é˜…
- âŒ è®¢é˜…å‡çº§/é™çº§
- âŒ ç§¯åˆ†æŒ‰æ¯”ä¾‹åˆ†é…ï¼ˆprorationï¼‰
- âŒ è‡ªåŠ¨ç»­è´¹ï¼ˆCreem.ioä¸æ”¯æŒï¼‰
- âŒ é€€æ¬¾å¤„ç†
- âŒ è®¢é˜…åˆ°æœŸé‚®ä»¶æé†’
- âŒ ç®¡ç†å‘˜è®¢é˜…ç®¡ç†ç•Œé¢

---

### ğŸ”§ æŠ€æœ¯æ ˆ

- **åç«¯**: Next.js 14 App Router API Routes
- **æ•°æ®åº“**: Supabase (PostgreSQL)
- **æ”¯ä»˜**: Creem.io
- **è®¤è¯**: Supabase Auth (Google OAuth)
- **ç±»å‹æ£€æŸ¥**: TypeScript (å·²é€šè¿‡ `npm run type-check`)

---

### ğŸ“ˆ æ€§èƒ½è€ƒè™‘

- **æ•°æ®åº“ç´¢å¼•**: 3ä¸ªæ–°ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦
- **å¹‚ç­‰æ€§**: é˜²æ­¢é‡å¤å¤„ç†å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
- **åŸå­æ“ä½œ**: å•æ¬¡æ•°æ®åº“äº‹åŠ¡å®Œæˆç§¯åˆ†åˆ†é…
- **ç¼“å­˜ç­–ç•¥**: ç”¨æˆ·æ¡£æ¡ˆdenormalizeè®¢é˜…ä¿¡æ¯ï¼ˆ`active_plan_id`, `subscription_expires_at`ï¼‰

---

### ğŸ› å·²çŸ¥é™åˆ¶

1. **æ‰‹åŠ¨ç»­è´¹**: Creem.ioä¸æ”¯æŒè‡ªåŠ¨æ‰£è´¹ï¼Œéœ€è¦åˆ°æœŸå‰é‚®ä»¶æé†’ç”¨æˆ·æ‰‹åŠ¨ç»­è´¹
2. **ç§¯åˆ†ä¸æ»šå­˜**: æœªä½¿ç”¨ç§¯åˆ†åœ¨å‘¨æœŸç»“æŸæ—¶è¿‡æœŸï¼ˆç®€åŒ–MVPé€»è¾‘ï¼‰
3. **æ— å‡çº§é™çº§**: ç”¨æˆ·å¿…é¡»å…ˆå–æ¶ˆç°æœ‰è®¢é˜…æ‰èƒ½æ›´æ¢è®¡åˆ’
4. **ç±»å‹æ¨æ–­é—®é¢˜**: Supabaseå…³è”æŸ¥è¯¢çš„ç±»å‹æ¨æ–­éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼ˆå·²è§£å†³ï¼‰

---

### ğŸ’¡ æœ€ä½³å®è·µ

æœ¬å®ç°éµå¾ªä»¥ä¸‹æœ€ä½³å®è·µï¼š

1. **å®‰å…¨**:
   - JWT tokenéªŒè¯
   - æœåŠ¡ç«¯æ”¯ä»˜éªŒè¯
   - SQLæ³¨å…¥é˜²æŠ¤ï¼ˆSupabaseå‚æ•°åŒ–æŸ¥è¯¢ï¼‰

2. **å¯é æ€§**:
   - å¹‚ç­‰æ€§è®¾è®¡
   - è¯¦ç»†é”™è¯¯æ—¥å¿—
   - åŸå­æ•°æ®åº“æ“ä½œ

3. **å¯ç»´æŠ¤æ€§**:
   - æ¸…æ™°çš„ä»£ç æ³¨é‡Š
   - å‡½æ•°èŒè´£å•ä¸€
   - TypeScriptç±»å‹å®‰å…¨

4. **ç”¨æˆ·ä½“éªŒ**:
   - æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
   - å‘¨æœŸç»“æŸå–æ¶ˆï¼ˆä¿ç•™è®¿é—®ï¼‰
   - é˜²æ­¢é‡å¤è®¢é˜…

---

### ğŸ“ æ”¯æŒå’Œé—®é¢˜

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **æœåŠ¡ç«¯æ—¥å¿—**: æŸ¥çœ‹ `=== Subscription Callback Started ===` ç­‰æ—¥å¿—
2. **æ•°æ®åº“çŠ¶æ€**: ä½¿ç”¨æµ‹è¯•æ–‡æ¡£ä¸­çš„SQLæŸ¥è¯¢
3. **Creem.io ä»ªè¡¨ç›˜**: éªŒè¯æ”¯ä»˜çŠ¶æ€
4. **æµè§ˆå™¨æ§åˆ¶å°**: æ£€æŸ¥ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯

---

## ğŸ¯ æ€»ç»“

**Phase 1ï¼ˆæ•°æ®åº“å’ŒAPIï¼‰å·²100%å®Œæˆï¼**

- âœ… 4ä¸ªAPIè·¯ç”±å…¨éƒ¨å®ç°
- âœ… æ•°æ®åº“schemaå·²æ‰©å±•
- âœ… TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… å®Œæ•´æµ‹è¯•æ–‡æ¡£å·²å‡†å¤‡
- âœ… å…³é”®åŠŸèƒ½å·²å®ç°ï¼ˆå¹‚ç­‰æ€§ã€æ”¯ä»˜éªŒè¯ã€ç§¯åˆ†åˆ†é…ï¼‰

**å‡†å¤‡è¿›å…¥Phase 2å‰ç«¯å¼€å‘ï¼**

å½“æ‚¨å®ŒæˆAPIæµ‹è¯•å¹¶ç¡®è®¤ä¸€åˆ‡æ­£å¸¸åï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å°†ç«‹å³å¼€å§‹å‰ç«¯ç»„ä»¶å¼€å‘ã€‚

---

**é¢„è®¡å‰©ä½™å·¥ä½œé‡**: 4.5å°æ—¶ï¼ˆå‰ç«¯å¼€å‘ï¼‰
**æ€»MVPé¢„è®¡æ—¶é—´**: 14å°æ—¶ï¼ˆå·²å®Œæˆçº¦7å°æ—¶ï¼‰
